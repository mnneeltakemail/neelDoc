# 建立去中心化交易所的动机 {#Decentralizedcryptocurrencyexchange(DEX)-Motivation}

随着各种加密代币的数量增加，加密代币之间转换和兑换的需求也逐渐增加。去中心化是区块链环境的其中一项主要特点，但直到近期只存有中心化的交易所，就连比特币及以太坊这些加密代币也是如此。许多交易所都支持加密货币，法定货币和加密代币的买卖。Coinbase，BTC-e，ShapeShift和Mt.Gox等就是中心化交易所的例子。在这个领域，中心化的经历是令人可悲的，造成失败的只有一个原因 - 就是交易所。 在这种情况下，所有的用户用来参与交易的资金都保存在同一个地方。 用户的资金直接存储在交易所中，它不仅负责匹配订单，并保持当前的订单簿和存款者的资金处于正确的状态。Mt.Gox的崩塌足以证明为什么中心化不可靠的最明显案例，由此造成约650,000 BTC的损失。由于所有用户的私钥保存在一起，交易所系统可被侵入而导致所有用户失去所有资金，BTC-e基金交易所就发生过这样的盗窃行为。而且这并不是唯一因为这种方式失去了储户资金的交易所。交易所使用去中心化的方式可以避免许多用户的资产卷入因入侵者带来的危险而引发的问题。

# 1. 去中心化交易所 (DEX) {#Decentralizedcryptocurrencyexchange(DEX)-DecentralizedExchange}

去中心化交易所不需要用户将他们的钱信托与交易所:用户的钱包并不受单一实体所操控。订单由用户本人直接数字签名，以此作为授权程序。用户可以掌控自己的资金，但是链上交易有个弊处，就是无法像中心化交易所那样实时交易。

去中心化交易所与中心化相比会有一些优势，但也有弊端。

如果交易所的所有组件都是去中心化，没有自动匹配的买卖指令，那这些匹配操作应该由用户来完成。例如，对于经过验证并放入订单簿的特定订单，任何其他用户都可以添加经过数字签名的回报订单，并将两个订单一同发送到区块链。然后资产在双方买卖中转移。

此外，由于缺乏自动匹配和快速取消的情况，开采者的前台运行存有漏洞。 下一个区块的开采者总是可以选择以他们自己作为交易对手执行取消订单，从而可能以这样的订单中获益。

那如果我们不将交易所的所有组件都去中心化，而只针对匹配器部分会怎样？ 这种设计可以避免上述两个问题：已经取消订单的套利者和开采者前台运行。 与中心化交易所不同的是，具有中心化匹配器的去中心化式解决方案将无法窃取用户的存款。

# 2. Waves去中心化交易所 (DEX) {#Decentralizedcryptocurrencyexchange(DEX)-WavesDEX}

Waves提供了一个去中心化交易所(DEX)，它允许用户之间可以来回交换不同的资产，就像传统的交易所，但由于其去中心化的特性，对最终用户提供了更强的安全保障。基于Waves创造一些新资产的机会，允许众筹股权提前交易，为代币提供流动性。为此，代币应该在公众场所出售，买卖双方都可以发布订单。

多亏了这个去中心化交易所唯一的中心化设计元素- 订单匹配器，我们可以实现实时交易，它可以在毫秒内匹配收到的订单并高速执行交易。没有必要以等待下一个区块去得知是否成功执行了交易，这提供了中心化交易所级别的速度和去中心化协议的安全性。

订单由单个节点成对连接，这些节点作为匹配器进行工作。在进入Waves区块链之前，交易都是由节点检查匹配订单的价格，以便匹配器不会执行“错误”的交易。然后，匹配器创建交易所交易，并签上其签名，将其放入区块链，以修改用户余额的变化。匹配器也可以匹配部分订单，就像普通交易所一样。交易确认后，匹配器的签名通过挖矿节点进行验证，并将交易放入区块链，根据金额和订单执行价格更改用户资产账户余额。重要的是，这些资金只有在区块链发布后才被转移。如果匹配器匹配失败，交易就不会执行，但是资金不会丢失，因为交易所并不掌控客户的资产。

用户通过创建，签署和向匹配器节点发送限价订单请求来启动他购买或出售资产的指令。 这里的限价订单与所有交易所相同：以相等或更好于指定价格买入（卖出）固定数量代币的订单。当一个新的订单提交给去中心化交易所时，其所有字段都会被检查是否充足，并且签名由发件人的公钥进行验证。然后，基于内部匹配器状态对订单进行验证：具有该身份证件的订单已不该存在，并且特定资产的所有订单金额的总合应该小于或等于发送方账户上该资产的余额。 图1显示了去中心化交易所的工作流程：

![](/_assets/DEX1.png)图1

用户可以为订单设置到期时间(最长有效时间)，当订单到期时将会自动取消。去中心化交易所有一条规定是，所有超过30天的订单都将被取消。每个订单的有效期由用户在签署订单时指定。有效期是一个长整数值，表示自UNIX历元以来的绝对秒数。当订单未履行，且其有效期超过了现在的UNIX时间戳时，用户可以取消该订单。在这种情况下，订单作为取消订单输入区块链内，并且自此之后没有人可以将它履行。

订单的完整执行周期如下：

1. 如果提交的订单没有按价格相匹配的回报订单，该订单将被放入相应的订单簿中。
2. 如果存在与提交订单相匹配的回报订单，该订单将被执行。 这意味着将回报订单从订单簿中删除，并且由匹配器创建交易所交易，通过匹配器的私钥对其进行签名，并将其发送到Waves网络中及区块链中。
3. 如果提交的订单数量大而足够执行几个订单，匹配器将创建多个交易。创建交易的数量等于相对应的回报订单量。按照他们的接受时间\(先入先出\)选择相应的回报订单。

在订单的每一个周期中，它都有一定的状态，这取决于它当前的生命周期处于哪个阶段。 当订单在订单簿中但尚未填时 - 它具有“已接受”状态，也可以是“填充”，“部分填充”或“已取消”。 未完全填充的订单可以被取消，之后订单将从匹配器的订单簿中删除。

# 3. 匹配器费用计算 {#Decentralizedcryptocurrencyexchange(DEX)-Matcherfeecalculation}

不管是买入还是卖出，或未来交易的金额多少，一个订单的固定全额交易费用是 **0.003waves** 。 交易所交易中包含两个不同的领域的匹配器费用，买方的订单和卖方的订单。一个订单可以通过几个交易完全执行，在这种情况下，所有匹配器费用都包含在该交易中。

如果订单是由 **一些部分** 交易事务执行的，那么匹配器费用与交易金额成比例地包含在该交易中，如

**交易金额 \* 订单匹配器费用 / 订单金额.**

此订单剩余的匹配器费用将包含在其他交易中，直至订单完全执行。

## 3.1 举例说明:

有3个不同的订单 \(如图2\) ：两个买单和一个卖单。对于每个完整订单，用户必须支付 **0.003 Waves** 的费用，并且这笔费用将在订单执行时被报销。 在我们的例子中:

* 根据交易1，订单1与订单3的70%完全匹配，匹配器支付给开采者的交易费也等于0.003waves，则此次交易的交易费用等于0.003 + 0.0021 - 0.003 = 0.0021。
* 根据交易2，订单2的50％与订单3的30％相匹配，则此次交易的匹配器费用等于0.0009 + 0.0015 - 0.003 = -0.0006waves。

因此，匹配器从这些交易中获得的费用是 **0.0021-0.0006 = 0.0015waves** 。 而匹配器向开采者支付的费用是 **0.006waves**。

![](/_assets/matcher.png) 图2：匹配器费用示例，TX1-交易1，TX2-交易2，Ord1-订单1，Ord2-订单2，Ord3-订单3.

###  {#Decentralizedcryptocurrencyexchange(DEX)-Summary:}

### 总结: {#Decentralizedcryptocurrencyexchange(DEX)-Summary:}

| 时间 | 匹配器费用 | 开采者费用 | 匹配器剩余 |
| :--- | :--- | :--- | :--- |
| 上个月 | 681.42336675 waves | 569.721 waves | 16.39% |
| 历来 | 3476.01418346 waves | 2824.771 waves | 18.74% |

总括来说，有史以来，匹配器只收取18.74％的费用，所有其他的都以交易成本支付给开采者\(数据统计截至2018年2月8日\)。

# 4.安装去中心化交易所 {#Decentralizedcryptocurrencyexchange(DEX)-InstallingDEX}

* 从我们的官方网站
  [www.wavesplatform.com](http://www.wavesplatform.com/) 下载
  , 或在
  [beta.wavesplatform.com](https://beta.wavesplatform.com/) 上使用 webwallet。
* 将您的 [比特币](/waves-client/transfers-and-gateways/bitcoin-transfers.md) 或其他任何 [受支持的代币存入钱包](waves-client/wallet-management.md) 并在 [Waves 去中心化交易所开始交易](/waves-client/waves-dex.md)。


# 5. 安装您专属的匹配器 {#Decentralizedcryptocurrencyexchange(DEX)-InstallingyourOwnMatcher}

* 用户可以通过安装Waves软件并启用匹配功能来安装专属的匹配器。
* 匹配器以提供的服务赚取费用，因此您可以大幅提高您的开采收入。
* 当用户向匹配器发送订单时，他不会将货币权转让给任何人，他的资金仍然被保留在他的账户上，直到订单与回报订单相匹配。

**提示.** 点击[**这里.**](/development-and-api/dex-api/matcher.md)找到关于匹配器的更多技术细节。
